{% extends "main.html" %}
{% load widget_tweaks %}

{% block title %}
List des rapports
{% endblock %}
{% load static %} 
{% block activeListReport %}{% include 'active_bar.html' %}{% endblock %}
{% block content %}
<div class="row mb-3">
    {% if page %}
    <form method="GET" style="margin: 20px 0px;">
        {% csrf_token %}
        <div class="row height d-flex justify-content-center align-items-center">
            <div class="col-md-6">
                <div class="form" style="position: relative;">
                    <i class="fa fa-search" style="position: absolute; top:12px; left: 17px; color: white;"></i>{{ filter.form.search }}
                </div>
            </div>
            <div class="col-md-2" style="width: 12%;">
                {{ filter.form.start_date }}
            </div>
            <div class="col-md-2" style="width: 12%;">
                {{ filter.form.end_date }}
            </div>
            <div class="col-md-2" style="width: 10%;">
                {{ filter.form.line }}
            </div>
            <div class="col-md-1" style="width: 7%;">
                <input type="number" class="form-control" value="{% if request.GET.page_size %}{{ request.GET.page_size }}{% else %}12{% endif %}" style="background-color: rgba(202, 207, 215, 0.5); 
                border-color: transparent; box-shadow: 0 0 6px rgba(0, 0, 0, 0.2); color: #f2f2f2; height: 40px;" name="page_size">
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-secondary btn-block customSaveButton" style="height: 40px;">Appliquer</button>
            </div>
        </div>
        <ul class="nav nav-tabs mt-3" style="border-bottom: 1px solid #b7b9bd;">
            <li class="nav-item {% if not request.GET.state %}customActive{% endif %}">
                <button class="nav-link text-decoration-none customUnactive {% if not request.GET.state %}text-white{% endif %}" onMouseOver="this.style.borderColor='transparent'; this.style.color='white';" 
                onMouseOut="this.style.color='#b7b9bd'" style="font-size: 1.15rem;" onclick="location.href='{% url 'list_report' %}'{% if request.GET.search %}?search={{ request.GET.search }}{% endif %};">
                    All {% if not request.GET.state %}({{ all_total }}){% endif %}
                </button>
            </li>
            {% with allowed_states=role_state|get_item:user.role %}
                {% for state in allowed_states %}            
                    <li class="nav-item {% if request.GET.state == state %}customActive{% endif %}">
                        <button class="nav-link text-decoration-none customUnactive {% if request.GET.state == state %}text-white{% endif %}" onMouseOver="this.style.borderColor='transparent'; this.style.color='white';" 
                        onMouseOut="this.style.color='#b7b9bd'" style="font-size: 1.15rem;" type="submit" name="state" value="{{ state }}">
                            {{ state }} ({{ state_totals|get_item:state }})
                        </button>
                    </li>
                {% endfor %}
            {% endwith %}
        </ul>
    </form>
    <section class="sectionList"> 
        <table class="table table-borderless">
            <thead style="border-bottom: 2px solid white;">
                <tr class="text-white" style="vertical-align: middle;">
                <th>N° Lot</th>
                <th style="width: 19vh;">Date de création</th>
                <th style="width: 8vh;">Date de production</th>
                <th>Équipe</th>
                <th>Produit</th>
                <th>Unité logistique</th>
                <th>Quantité</th>
                <th>Total d'arréts</th>
                <th>État</th>
                {% if user.role == 'Gestionnaire de production' %}
                    <th style="width: 6vh;">Actions</th>
                {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for report in page %}
                <tr style="color: #dde3f0;">
                    <td onclick="window.location='{% url 'report_detail' report.id %}'" style="cursor: pointer;">{{ report.n_lot }}</td>
                    <td onclick="window.location='{% url 'report_detail' report.id %}'" style="cursor: pointer;">{{ report.date_created|date:"d/m/Y h:i" }}</td>
                    <td onclick="window.location='{% url 'report_detail' report.id %}'" style="cursor: pointer;">{{ report.prod_day|date:"d/m/Y" }}</td>
                    <td onclick="window.location='{% url 'report_detail' report.id %}'" style="cursor: pointer;">{{ report.team }}</td>
                    <td onclick="window.location='{% url 'report_detail' report.id %}'" style="cursor: pointer;">{{ report.prod_product }}</td>
                    <td onclick="window.location='{% url 'report_detail' report.id %}'" style="cursor: pointer;">{{ report.qte_sac_prod }} {{ report.prod_product.unite.conditionnement }}</td>
                    <td onclick="window.location='{% url 'report_detail' report.id %}'" style="cursor: pointer;">{{ report.qte_tn }} {{ report.prod_product.unite.code }}</td>
                    <td onclick="window.location='{% url 'report_detail' report.id %}'" style="cursor: pointer;">{{ report.total_arrets }}h</td>
                    <td onclick="window.location='{% url 'report_detail' report.id %}'" style="cursor: pointer;">{{ report.state }}</td>
                    {% if report.creator == user and user.role == 'Gestionnaire de production' %}
                    <td style="vertical-align: middle; padding: 8px 0px; text-align: center;">            
                        <button type="button" onclick="window.location='{% url 'update_report' report.id %}'"  style="padding: 2px;"
                        class="btn" {% if report.state != 'Brouillon' %} disabled {% endif %}><i class="fas fa-edit" style="color: white;"></i></button>
                        {% if report.creator and report.creator == user %}
                            <button type="button" {% if report.state != 'Brouillon' %} disabled {% endif %}  style="padding: 2px;" onclick="confirmRepDel('{{report.id|escapejs}}', '{{report.n_lot|escapejs}}', '{{report.team|escapejs}}', '{{report.prod_day|escapejs}}', '{{report.prod_product|escapejs}}')" class="btn">
                                <i class="far fa-trash-alt" style="color: white;"></i>
                            </button>
                        {% endif %}
                    </td>
                    {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if page.has_other_pages %}
            {% include 'pagination.html' %}
        {% endif %}    
    </section>
    {% else %}
    <form method="GET" style="margin: 20px 0px;">
        {% csrf_token %}
        <div class="row height d-flex justify-content-center align-items-center">
            <div class="col-md-6">
                <div class="form" style="position: relative;">
                    <i class="fa fa-search" style="position: absolute; top:12px; left: 17px; color: white;"></i>{{ filter.form.search }}
                </div>
            </div>
        </div>
        <ul class="nav nav-tabs mt-3" style="border-bottom: 1px solid #b7b9bd;">
            <li class="nav-item {% if not request.GET.state %}customActive{% endif %}">
                <button class="nav-link text-decoration-none customUnactive {% if not request.GET.state %}text-white{% endif %}" onMouseOver="this.style.borderColor='transparent'; this.style.color='white';" 
                onMouseOut="this.style.color='#b7b9bd'" style="font-size: 1.15rem;" onclick="location.href='{% url 'list_report' %}'{% if request.GET.search %}?search={{ request.GET.search }}{% endif %};">
                    All {% if not request.GET.state %}({{ all_total }}){% endif %}
                </button>
            </li>
            {% with allowed_states=role_state|get_item:user.role %}
                {% for state in allowed_states %}            
                    <li class="nav-item {% if request.GET.state == state %}customActive{% endif %}">
                        <button class="nav-link text-decoration-none customUnactive {% if request.GET.state == state %}text-white{% endif %}" onMouseOver="this.style.borderColor='transparent'; this.style.color='white';" 
                        onMouseOut="this.style.color='#b7b9bd'" style="font-size: 1.15rem;" type="submit" name="state" value="{{ state }}">
                            {{ state }} ({{ state_totals|get_item:state }})
                        </button>
                    </li>
                {% endfor %}
            {% endwith %}
        </ul>
    </form>
        {% include 'empty_list.html' %}
    {% endif %}
</div>
<style>
    select option {
        background: rgba(127, 139, 161, 0.9);
    }
</style>
<script>
    const confirmRepDel = (repID, repNLt, repTeam, repDay, repProd) => {
        swal({ 
        title: `Confirmation de la suppression.`,   
        text: `Voulez-vous vraiment supprimer ce rapport : \nProduit: ${repProd}\nN° Lot:${repNLt}.\nPar ${repTeam} le ${repDay} ?`,   
        type: "warning",
        showCancelButton: true,   
        confirmButtonColor: "#DD6B55",   
        confirmButtonText: "Oui",   
        cancelButtonText: "Non",   
        closeOnConfirm: true,   
        closeOnCancel: true }, 
        function(isConfirm){   
            if (isConfirm){
              window.location.href = "{% url 'delete_report' 123456789 %}".replace(/123456789/, repID);
            }});
      }
</script>
{% endblock content %}